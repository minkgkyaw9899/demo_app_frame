"use strict";var we=Object.create;var O=Object.defineProperty;var xe=Object.getOwnPropertyDescriptor;var Re=Object.getOwnPropertyNames;var be=Object.getPrototypeOf,Se=Object.prototype.hasOwnProperty;var Ue=(r,e,o,t)=>{if(e&&typeof e=="object"||typeof e=="function")for(let s of Re(e))!Se.call(r,s)&&s!==o&&O(r,s,{get:()=>e[s],enumerable:!(t=xe(e,s))||t.enumerable});return r};var i=(r,e,o)=>(o=r!=null?we(be(r)):{},Ue(e||!r||!r.__esModule?O(o,"default",{value:r,enumerable:!0}):o,r));var Pe=i(require("http")),E=i(require("express"));var A=i(require("dotenv"));A.default.config();var k=process.env.PORT||3e3,$=process.env.ROUNDS?+process.env.ROUNDS:10,Ce=process.env.ENCRYPT_PASSWORD??"ace_encrypt_password",Te=process.env.ENCRYPT_SALT??"salt",Ee=process.env.ENCRYPT_COST?+process.env.ENCRYPT_COST:5,ke=process.env.ENCRYPT_LEGNTH?+process.env.ENCRYPT_LEGNTH:256,N=process.env.JWT_SECRET??"jwt secure secret 123";var w=i(require("consola")),D=require("chalk"),m=new D.Chalk({level:3}),u=(r,e,o)=>{switch(r){case"success":return w.default.success(` ${m.bgGreen.black.bold(e)} ${m.green(o)}`);case"error":return w.default.error(` ${m.bgRed.whiteBright.bold(e)} ${m.redBright(o)}`);case"warn":return w.default.warn(` ${m.bgYellow.whiteBright.bold(e)} ${m.yellowBright(o)}`);case"info":return w.default.info(` ${m.bgBlue.whiteBright.bold(e)} ${m.blueBright(o)}`)}};var he=i(require("http-errors"));var X=require("express");var j=i(require("http-errors"));var S=i(require("bcrypt"));var M=async r=>{let e=await S.default.genSalt($);return await S.default.hash(r,e)},Y=async(r,e)=>await S.default.compare(r,e);var U=require("@prisma/client"),q=new U.PrismaClient,v=q.user,l=q.post,je=q.$connect(),Fe=q.$disconnect(),C=U.Prisma.PrismaClientKnownRequestError,I=(r,e)=>{for(let o of e)delete r[o];return r};var a=(r,e)=>Promise.reject({status:r,message:e||"Internal Server Error"});var L=async r=>{try{return await v.findUnique({where:{id:r}})}catch(e){return a(500,e?.message)}},Z=async r=>{try{let{password:e,name:o,email:t}=r,s=await M(e),n={name:o,email:t,password:s};return await v.create({data:n})}catch(e){return e instanceof C&&e.code==="P2002"?a(409,"User already existed with that email"):a(500)}},K=async r=>{try{return await v.findUnique({where:{email:r}})}catch(e){if(u("error","findUserByEmail",e?.message),e)return a(500,"Db error")}};var _=i(require("jsonwebtoken"));var B=r=>_.default.sign(r,N),z=r=>{try{return{decoded:_.default.verify(r,N),expired:!1,valid:!0}}catch(e){return u("error","verify token",e?.message),{valid:!1,decoded:null,expired:e.message==="jwt expired"}}};var G=async(r,e,o)=>{let t=r.body;try{let s=I(await Z(t),["password"]),n=B({id:s.id,email:s.email});return e.status(201).json({meta:{status:201,message:"Successfully register user"},data:{user:s,token:n}})}catch(s){return o(s)}},Q=async(r,e,o)=>{try{let{email:t,password:s}=r.body,n=await K(t);if(!n)return o((0,j.default)(404,"User not found"));if(!await Y(s,n.password))return o((0,j.default)(401,"Invalid email or password"));let f=B({id:n.id,email:n.email});return e.status(200).json({meta:{status:200,message:"Successfully login"},data:{user:I(n,["password"]),token:f}})}catch(t){return o(t)}};var W=require("zod"),F=i(require("http-errors"));var g=r=>async(e,o,t)=>{try{return await r.parseAsync({body:e.body,query:e.query,params:e.params}),t()}catch(s){if(s instanceof W.ZodError){let n=s.issues.map(p=>p.message)[0];return t((0,F.default)(422,n))}return u("error","validator middleware",s?.message),t((0,F.default)(422))}};var c=require("zod"),J=(0,c.object)({body:(0,c.object)({name:(0,c.string)({required_error:"Name is required"}),email:(0,c.string)({required_error:"Email is required"}).email("Invalid email format"),password:(0,c.string)({required_error:"Password is required"})})}),V=(0,c.object)({body:(0,c.object)({email:(0,c.string)({required_error:"Email is required"}).email("Invalid email format"),password:(0,c.string)({required_error:"Password is required"})})});var H=(0,X.Router)();H.post("/register",g(J),G);H.post("/login",g(V),Q);var ee=H;var P=i(require("http-errors"));var re=async(r,e,o)=>{try{let t=r.headers.authorization;if(!t)return o((0,P.default)(401));let[s,n]=t.split(" ");if(s!=="Bearer")return o((0,P.default)(401,"Invalid token type"));let{decoded:p,valid:f,expired:x}=z(n);if(x)return o((0,P.default)(401,"Token expired"));if(!f)return o((0,P.default)(401,"Invalid token"));let{id:R}=p,b=await L(R);return b?(e.locals.user={id:b.id},o()):o((0,P.default)(401,"User not found"))}catch(t){return o(t)}};var fe=require("express");var te=async()=>{try{return await l.count()}catch(r){return a(500,r?.message)}},oe=async({skip:r,take:e})=>{try{return await l.findMany({skip:r,take:e,include:{postBy:{select:{id:!0,name:!0}}}})}catch(o){return a(500,o?.message)}},se=async r=>{try{return await l.findUnique({where:{id:r},include:{postBy:{select:{id:!0,name:!0}}}})}catch(e){return a(500,e?.message)}},ne=async r=>{try{return await l.create({data:r})}catch(e){return u("error","createPost",e.message),a(500,e.message)}},ae=async r=>{let{postId:e,title:o,body:t}=r;try{return await l.update({where:{id:e},data:{title:o,body:t}})}catch(s){return a(500,s?.message)}},ie=async r=>{try{return await l.delete({where:{id:r}})}catch(e){return e instanceof C&&e.code==="P2025"?a(404,"Post not found"):a(500,"Db error")}};var T=i(require("http-errors")),ce=async(r,e,o)=>{try{let t=r.body,s=e.locals.user?.id,n={...t,userId:s},p=await ne(n);return e.status(200).json({meta:{status:200,message:"Successfully create new post"},data:{post:p}})}catch(t){return o(t)}},pe=async(r,e,o)=>{try{let t=r.query.pages?parseInt(r.query.pages):1;if(isNaN(t))return o((0,T.default)(422,"Pages should be number type"));let s,n=20;t<=1?s=0:s=(t-1)*n,console.log(s);let p=await oe({skip:s,take:n});t=t++;let f=await te(),x=Math.ceil(f/n),R=t<x,b=R?t+1:null;return e.status(200).json({meta:{status:200,message:"Successfully create new post",total:f,totalPages:x,currentPages:t,hasNextPage:R,nextPage:b},data:{posts:p}})}catch(t){return o(t)}},ue=async(r,e,o)=>{try{let t=r.params.id;if(!t)return o((0,T.default)(422,"Post id not found"));let s=await se(t);return s?e.status(200).json({meta:{status:200,message:"Successfully get post"},data:{post:s}}):o((0,T.default)(404,"Post not found"))}catch(t){return o(t)}},de=async(r,e,o)=>{try{let t=r.params.id,s=e.locals.user?.id,n={postId:t,userId:s,...r.body},p=await ae(n);return e.status(202).json({meta:{status:202,message:"Successfully create new post"},data:{post:p}})}catch(t){return o(t)}},me=async(r,e,o)=>{try{let t=r.params.id,s=await ie(t);return e.status(200).json({meta:{status:200,message:"Successfully deleted post"},data:{post:{id:t}}})}catch(t){return o(t)}};var d=require("zod"),le=(0,d.object)({body:(0,d.object)({title:(0,d.string)({required_error:"Title is required"}),body:(0,d.string)({required_error:"Body is required"})})}),ye=(0,d.object)({body:(0,d.object)({title:(0,d.string)({required_error:"Title is required"}).optional(),body:(0,d.string)({required_error:"Body is required"}).optional()})});var h=(0,fe.Router)();h.get("/",pe);h.get("/:id",ue);h.post("/",g(le),ce);h.patch("/:id",g(ye),de);h.delete("/:id",me);var ge=h;var y=(0,E.default)();y.use(E.default.json());y.use(E.default.urlencoded({extended:!0}));y.use("/api/v1/users",ee);y.use("/api/v1/posts",re,ge);y.use((r,e,o)=>o((0,he.default)(404,"Your request was not found")));y.use((r,e,o,t)=>{let s=r.status??500,n=r.message??"Internal Server Error";return o.status(s).json({error:{status:s,message:n}})});var qe=Pe.default.createServer(y);qe.listen(k,()=>u("success","startup",`Server listening on ${k}`));
//# sourceMappingURL=app.js.map